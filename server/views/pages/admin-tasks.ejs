<%- include('../partials/header.ejs') %>

<div class="main admin-tasks">
  <h1 class="admin-tasks__title">Tasks</h1>
  <h2 class="admin-tasks__subtitle">Add tasks</h2>
  <form class="admin-tasks__form" method="POST" action="/admin/tasks">
    <label class="admin-tasks__label" for="title">Title:
      <input class="admin-tasks__input" type="text" name="title" id="title" required />
    </label>
    <label class="admin-tasks__label" for="object_type">Object Type:
      <select class="admin-tasks__select" name="object_type" id="object_type" required>
        <option value="department">Department</option>
        <option value="sub_department">Sub Department</option>
        <option value="pump">Pump</option>
        <option value="filter">Filter</option>
      </select>
    </label>
    <label class="admin-tasks__label" for="object_id">Object ID:
      <select class="admin-tasks__select" name="object_id" id="object_id" required>
        <!-- Options will be filled by JS -->
      </select>
    </label>
    <label class="admin-tasks__label" for="interval">Interval:
      <select class="admin-tasks__select" name="interval" id="interval" required>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
    </label>
    <button class="admin-tasks__button button" type="submit">Add Task</button>
  </form>

  <% departments.forEach(function(department) { %>
    <h3 class="admin-tasks__department-title"><%= department.title %></h3>
    <div class="admin-tasks__table-container">
      <table class="admin-tasks__table">
        <thead>
          <tr class="admin-tasks__table-row">
            <th class="admin-tasks__table-header">Title</th>
            <th class="admin-tasks__table-header">Task type</th>
            <th class="admin-tasks__table-header">Department</th>
            <th class="admin-tasks__table-header">Interval</th>
            <th class="admin-tasks__table-header">Completed</th>
            <th class="admin-tasks__table-header">Action</th>
          </tr>
        </thead>
        <tbody>
          <% tasks.filter(task=> {
            if (task.object_type === "department") {
              return task.object_id === department.id;
            }
            if (task.object_type === "sub_department") {
              const sub = sub_departments.find(s => s.id === task.object_id);
              return sub && sub.department_id === department.id;
            }
            if (task.object_type === "pump") {
              const pump = pumps.find(p => p.id === task.object_id);
              if (pump && pump.department_id) {
                return pump.department_id === department.id;
              }
              if (pump && pump.sub_department_id) {
                const sub = sub_departments.find(s => s.id === pump.sub_department_id);
                return sub && sub.department_id === department.id;
              }
              return false;
            }
            if (task.object_type === "filter") {
              const filter = filters.find(f => f.id === task.object_id);
              if (filter && filter.department_id) {
                return filter.department_id === department.id;
              }
              if (filter && filter.sub_department_id) {
                const sub = sub_departments.find(s => s.id === filter.sub_department_id);
                return sub && sub.department_id === department.id;
              }
              return false;
            }
            return false;
            }).forEach(task => { %>
            <tr class="admin-tasks__table-row">
              <td class="admin-tasks__table-cell">
                <input type="text" name="title" value="<%= task.title %>" class="admin-tasks__input admin-tasks__input--title"
                  form="form-<%= task.id %>" disabled />
              </td>
              <td class="admin-tasks__table-cell">
                <select name="object_type" class="admin-tasks__select admin-tasks__select--object-type" form="form-<%= task.id %>"
                  disabled>
                  <option value="department" <%=task.object_type==="department" ? "selected" : "" %>>Department</option>
                  <option value="sub_department" <%=task.object_type==="sub_department" ? "selected" : "" %>>Sub Department</option>
                  <option value="pump" <%=task.object_type==="pump" ? "selected" : "" %>>Pump</option>
                  <option value="filter" <%=task.object_type==="filter" ? "selected" : "" %>>Filter</option>
                </select>
              </td>
              <td class="admin-tasks__table-cell">
                <% if (task.object_type==="department" ) { %>
                  <%= department.title %>
                <% } else if (task.object_type==="sub_department" ) { %>
                  <%= sub_departments.find(s=> s.id === task.object_id).title %>
                <% } else if (task.object_type==="pump" ) { %>
                  <%= pumps.find(p=> p.id === task.object_id).title %>
                <% } else if (task.object_type==="filter" ) { %>
                  <%= filters.find(f=> f.id === task.object_id).title %>
                <% } %>
              </td>
              <td class="admin-tasks__table-cell">
                <select name="interval" class="admin-tasks__select admin-tasks__select--interval" form="form-<%= task.id %>" disabled>
                  <option value="daily" <%=task.interval==="daily" ? "selected" : "" %>>Daily</option>
                  <option value="weekly" <%=task.interval==="weekly" ? "selected" : "" %>>Weekly</option>
                  <option value="monthly" <%=task.interval==="monthly" ? "selected" : "" %>>Monthly</option>
                </select>
              </td>
              <td class="admin-tasks__table-cell">
                <select name="completed" class="admin-tasks__select admin-tasks__select--completed" form="form-<%= task.id %>" disabled>
                  <option value="true" <%=task.completed ? "selected" : "" %>>Yes</option>
                  <option value="false" <%=!task.completed ? "selected" : "" %>>No</option>
                </select>
              </td>
              <td class="admin-tasks__table-cell">
                <form method="POST" action="/admin/tasks/<%= task.id %>" class="admin-tasks__task-form" id="form-<%= task.id %>">
                  <button class="admin-tasks__edit-btn button" type="button" data-task-id="<%= task.id %>">Edit</button>
                  <button class="admin-tasks__save-btn button" type="submit" style="display:none;">Save</button>
                </form>
              </td>
            </tr>
            <% }) %>
        </tbody>
      </table>
    </div>
  <% }) %>

  <%- include('../partials/navigation.ejs')%>
</div>

<script defer src="/scripts/admin-tasks-dynamic.js"></script>
<script defer src="/scripts/admin-tasks-edit.js"></script>