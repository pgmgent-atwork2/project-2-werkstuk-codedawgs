<%- include('../partials/header.ejs')%>

    <% const monthNames=["January", "February" , "March" , "April" , "May" , "June" , "July" , "August" , "September"
        , "October" , "November" , "December" ]; %>

        <section class="main analysis-page">
            <h1 class="analysis-page__title">Select sub department:</h1>
            <form id="analysisFilterForm" method="GET" action="/general/analysis">
                <button type="button" onclick="window.location.href='/general/analysis'">Clear filters</button>
                <select class="analysis-page__subdepartment-select select" name="filter_sub_department"
                    id="filter_sub_department">
                    <option value="all" <%=typeof filter_sub_department==='undefined' || filter_sub_department==='all'
                        ? 'selected' : '' %>>All</option>
                    <% sub_departments.forEach(sub_department_item=> { %>
                        <option value="<%= sub_department_item.id %>" <%=typeof filter_sub_department !=='undefined' &&
                            filter_sub_department==sub_department_item.id ? 'selected' : '' %>>
                            <%= departments[sub_department_item.department_id-1].title %> | <%=
                                    sub_department_item.title %>
                        </option>
                        <% }); %>
                </select>
                <select class="analysis-page__subdepartment-select select" name="startMonth" id="startMonth">
                    <option value="">All</option>
                    <% for(let m=1; m<=12; m++) { %>
                        <option value="<%= m %>" <%=typeof startMonth !=='undefined' && startMonth==m ? 'selected' : ''
                            %>>
                            <%= monthNames[m-1] %>
                        </option>
                        <% } %>
                </select>
                <select class="analysis-page__subdepartment-select select" name="startYear" id="startYear">
                    <option value="">All</option>
                    <% const currentYear=new Date().getFullYear(); %>
                        <% for(let y=currentYear-5; y<=currentYear+1; y++) { %>
                            <option value="<%= y %>" <%=typeof startYear !=='undefined' && startYear==y ? 'selected'
                                : '' %>
                                ><%= y %>
                            </option>
                            <% } %>
                </select>
                <select class="analysis-page__subdepartment-select select" name="endMonth" id="endMonth">
                    <option value="">All</option>
                    <% for(let m=1; m<=12; m++) { %>
                        <option value="<%= m %>" <%=typeof endMonth !=='undefined' && endMonth==m ? 'selected' : '' %>>
                            <%= monthNames[m-1] %>
                        </option>
                        <% } %>
                </select>
                <select class="analysis-page__subdepartment-select select" name="endYear" id="endYear">
                    <option value="">All</option>
                    <% for(let y=currentYear-5; y<=currentYear+1; y++) { %>
                        <option value="<%= y %>" <%=typeof endYear !=='undefined' && endYear==y ? 'selected' : '' %>><%=
                                y %>
                        </option>
                        <% } %>
                </select>
                <button type="submit" class="button">Apply filter</button>
                <span id="dateRangeError" style="color: red; display: none;"></span>
            </form>
            <button class="analysis__new analysis-page__new-btn button">New analysis</button>
            <form class="analysis__form analysis-page__form" id="analysisForm" action="/tasks/analysis" method="POST">
                <h2 class="analysis-page__form-title">Add water analysis</h2>
                <select class="timeSelect analysis-page__time-select select" name="time">
                    <option value="1">Morning</option>
                    <option value="2">Afternoon</option>
                </select>
                <select class="subDepartmentSelect analysis-page__subdepartment-select select" name="sub_department"
                    id="sub_department">
                    <option value="all" <%=typeof sub_department==='undefined' || sub_department==='all' ? 'selected'
                        : '' %>>All</option>
                    <% sub_departments.forEach(sub_department_item=> { %>
                        <option value="<%= sub_department_item.id %>" <%=typeof sub_department !=='undefined' &&
                            sub_department==sub_department_item.id ? 'selected' : '' %>>
                            <%= departments[sub_department_item.department_id-1].title %> | <%=
                                    sub_department_item.title %>
                        </option>
                        <% }); %>
                </select>
                <% measurement_definitions.forEach(measurement_definition=> { %>
                    <div class="measurement__input analysis-page__measurement-input">
                        <label class="analysis-page__measurement-label">
                            <%= measurement_definition.name%>
                                (<%= measurement_definition.unit%>)
                        </label>
                        <input class="value-input analysis-page__value-input" <%=[2, 4, 5,
                            6].includes(measurement_definition.id) ? "required" : "" %>
                        name="<%= measurement_definition.id %>"
                            id="<%= measurement_definition.id %>"
                                type="number" step="0.01">
                    </div>
                    <% }); %>
                        <div class="analysis-page__comment">
                            <label class="analysis-page__comment-label">Comment</label>
                            <input class="analysis-page__comment-input" name="comment" placeholder="Optional comment">
                        </div>
                        <button type="button" class="analysis__close analysis-page__close-btn button">Cancel</button>
                        <button type="submit" class="analysis__add analysis-page__add-btn button">Add analysis</button>
            </form>
            <div class="analysis-page__tables">
                <button type="button" class="export-excel-btn" data-table="analysis-page__table-morning">Export to Excel</button>
                <div class="analysis-page__table-container">
                    <table class="analysis-page__table analysis-page__table-morning" border="1px">
                        <tr>
                            <th></th>
                            <th></th>
                            <th colspan="2">Depolox</th>
                            <th colspan="3">Manual</th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                        <tr>
                            <th>Date</th>
                            <% measurement_definitions.forEach(measurement_definition=> { %>
                                <th>
                                    <%= measurement_definition.short%>
                                </th>
                                <% }); %>
                                    <th>User</th>
                                    <th>Comment</th>
                        </tr>
                        <tr>
                            <td></td>
                            <% measurement_definitions.forEach(measurement_definition=> { %>
                                <td>
                                    <%= measurement_definition.unit%>
                                </td>
                                <% }); %>
                                    <td></td>
                                    <td></td>
                        </tr>

                        <% measurement_logs.forEach(measurement_log=> { %>
                            <% if(measurement_log.time===1) { %>
                                <% const measurements=JSON.parse(measurement_log.measurements) %>
                                    <% const date=new Date(measurement_log.measured_date) %>
                                        <% const options={ hour12: false, year: 'numeric' , month: '2-digit' ,
                                            day: '2-digit' };%>

                                            <tr class="row analysis-page__row"
                                                data-sub-department-id="<%= measurement_log.sub_department_id  %>">
                                                <td>
                                                    <%= date.toLocaleString('en-GB', options) %>
                                                </td>
                                                <% for (const measurement in measurements) { %>
                                                    <td>
                                                        <%= measurements[measurement] %>
                                                    </td>
                                                    <% } %>
                                                        <td>
                                                            <%= users[measurement_log.user_id].first_name %>
                                                        </td>
                                                        <td>
                                                            <%= measurement_log.comment %>
                                                        </td>
                                            </tr>
                                            <% } %>
                                                <% }); %>
                    </table>
                </div>
                <button type="button" class="export-excel-btn" data-table="analysis-page__table-afternoon">Export to Excel</button>
                <div class="analysis-page__table-container">
                    <table class="analysis-page__table analysis-page__table-afternoon" border="1px">
                        <tr>
                            <th></th>
                            <th>Depolox</th>
                            <th colspan="3">Manual</th>
                            <th></th>
                            <th></th>
                        </tr>
                        <% const allowedArr=[2, 4, 5, 6] %>
                            <tr>
                                <th>Date</th>
                                <% for(let i=0; i < allowedArr.length; i++) { %>
                                    <th>
                                        <%= measurement_definitions[allowedArr[i]-1].short%>
                                    </th>
                                    <% } %>
                                        <th>User</th>
                                        <th>Comment</th>
                            </tr>
                            <tr>
                                <th></th>
                                <% for(let i=0; i < allowedArr.length; i++) { %>
                                    <th>
                                        <%= measurement_definitions[allowedArr[i]-1].unit%>
                                    </th>
                                    <% } %>
                                        <th></th>
                                        <th></th>

                            </tr>

                            <% measurement_logs.forEach(measurement_log=> { %>
                                <% if(measurement_log.time===2) { %>
                                    <% const measurements=JSON.parse(measurement_log.measurements) %>
                                        <% const date=new Date(measurement_log.measured_date) %>
                                            <% const options={ hour12: false, year: 'numeric' , month: '2-digit' ,
                                                day: '2-digit' };%>

                                                <tr class="row analysis-page__row"
                                                    data-sub-department-id="<%= measurement_log.sub_department_id  %>">
                                                    <td>
                                                        <%= date.toLocaleString('en-GB', options) %>
                                                    </td>
                                                    <% for (const measurement in measurements) { %>
                                                        <% if(measurements[measurement]) { %>
                                                            <td>
                                                                <%= measurements[measurement] %>
                                                            </td>
                                                            <% } %>
                                                                <% } %>
                                                                    <td>
                                                                        <%= users[measurement_log.user_id].first_name %>
                                                                    </td>
                                                                    <td>
                                                                        <%= measurement_log.comment %>
                                                                    </td>
                                                </tr>
                                                <% } %>
                                                    <% }); %>
                    </table>
                </div>
            </div>
        </section>
        <script defer src="/scripts/validate-date-range.js"></script>
        <script defer src="/scripts/analysis-add.js"></script>
        <script defer src="/scripts/export-to-excel.js"></script>

        <%- include('../partials/navigation.ejs')%>